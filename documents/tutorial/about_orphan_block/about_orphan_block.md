# 孤块产生的原因推测与解决思路

很多矿工一直被孤块所困扰，产生原因也一直没有说得清楚，最近在slack和一个社区成员聊天，经过一翻学习，就把成果拿出来分享给大家，以让更多的中小矿工能够减少这种困扰，当然，本文是基于事实与逻辑的推测，如有不对的地方，欢迎指正！

## 　当前的块产生逻辑

当你被选中出块时，你要等6s以确保所有父块都能到达，这个6s叫做PropagationDelaySecs（广播延时）代码实现在[这里](https://github.com/filecoin-project/lotus/blob/master/build/params_mainnet.go#L79)，然后你有24s的时间去计算winning post，再广播出去，完成一轮区块生产的过程，获得区块奖励，同样的，下一轮有权出块的SP也要等你6s以确保收到你的区块

## 为什么会产生孤块

可能的原因有以下几个：
１：你计算winning post超时，虽然你获得了资格，但生产的区块依然不会被其它块所接受，这个很好理解
２：你有网络故障，别人都可以收到所有的父块，但由于网络不好，你没有在下一轮结束后的6s内收到所有父块，导致你没有包含所有的父块，你生产的区块不被网络所接受
３：你并没有任何问题，就是有一个父块计算超时了，这个父块在上一轮结束后6s内没有到达，但是可能在第10s到了，如果网络中所有的SP都不接受这个块，就没有任何问题，但是由于有SP修改了PropagationDelaySecs，他接受这个迟到的块做为父块，由于这个块是合法的出块者，只是晚到了，所以主网认为包含所有父块的出块者才是主链，而你跑到了分叉上，于是你的出块被判定为孤块，没有出块奖励。这种修改影响区块奖励的公平性，本应丢弃的父块打包进主网，而尊守规则的sp反而跑到了侧链上，没有区块奖励

## 　实际的例子

这个孤块可能是因为网络故障引起的：
>1156079 2021-09-30 15:59:30 bafy2bzacec4aihsjgpjr4de37dhqmhksrsk74xcp2hrystadkujknfc3xtnsc f01240218

可以观察到父块及时到达，并且只有f01240218没有包含父块，可能的原因是：f01240218在等待上一轮6s以后，依然没有收到更多的父块，于是开始做winning post, 由于缺少父块，被判定为孤块.

这个孤块产生的原因可能不是自己引起的，而是因为别的sp修改了PropagationDelaySecs
> 1155982 2021-09-30 15:11:00 bafy2bzaceah43pegp5oha2gxtybsmxpaqms4kub5qqjpl4ykfmzavu2jsyqwq  f01012

迟到的父块为：https://filfox.info/en/block/bafy2bzacecyn6zmhxlmsgbyi3e7eyq2key5qhqi63niflknwjanw5tb2pjvq6
我在filscan提供的工具上可以看到这个区块应该到达时间：2021-9-30 15:10:30 实际到达时间：2021-9-30 15:10:47
但是你在filfox浏览器上查看区块时间的时侯，发现区块时间是2021-9-30 15:10:30，这个原因可能是filfox并不会直接记录区块时间，只需要每个区块增加30s即可，他们不需要记录实际区块到达的时间，为什么这么推测？
因为当一个区块慢的时侯，他不止到达一个节点慢，到达所有节点都慢，所以可以明显观察到，有１个以上的节点都缺少这个父块，因为这个块到达所有节点都慢了。而如果是网络故障导致的父块到达缓慢，理论上只能影响一个节点。不太可能出现同时两个节点缺少同一个父块的情形。

## 　减少孤块的思路

我们可以减少孤块吗？　我认为可以！
f02303 自从7.12以后显著的减少了孤块　f09037几呼没有孤块
数据来源于https://www.filscout.com/en/orphan-block/alllist

### 　方法１

如果你总是出现孤块，显著高于平均值，很大概率是网络问题，因为计算winningpost超时是所有sp不能够容忍的，你一直很晚才能收到所有父块，那网络问题的可能性更大，更换运营商线路或者加大Lotus Daemon的带宽值得一试

### 　方法２

修改PropagationDelaySecs
这样做的好处：　　
１：即便有人出块晚了，你也可以多等一会儿，以确保打包到所有父块，减少孤块产生.　　
２：假如你是出块晚的那个人，计算超时了，你会发现，你仍然拿到区块奖励了，例如你用了30+15秒，理论上你不应该拿到奖励的，但就是有sp把你的块当做父块，你依然是合法的出块者.

这样做的坏处：　　
１：损坏网络的公平性，有些人没有修改代码，当出现迟到的父块的时侯，他们没有范任何错误，错过了一个块　　
２：如果你修改的时间过久，没有及时的计算出winningpost，你正常的出块机会将会浪费掉，造成损失

## 　如果你不确定自己在做什么，不要轻易的修改代码
